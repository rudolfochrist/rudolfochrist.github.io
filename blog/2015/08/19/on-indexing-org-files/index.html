<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>On indexing org files - Sebastian Christ</title>
    <meta charset="utf-8" />
    <meta name="author" content="Sebastian Christ" />
    <meta name="keywords" content="emacs, search, lisp" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  </head>

  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title"><a href="/">Sebastian Christ</a></h1>
        <p>(funcall (Î» ()))</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/rudolfochrist">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="http://www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="rudolfochrist.github.io">
        </form>
      </header>
    </div>

<div>
<div class="post">
<h1>On indexing org files</h1>
<p>
Since indexing org file is kind of <i>en vogue</i> lately, I thought that I should present my own home-brewed
solution. Firstly, I tried to use <a href="http://oremacs.com/2015/07/27/counsel-recoll/">recoll</a>, but unfortunately I was unable to compile it on OSX. Because I store
all of my notes in one huge org file, <a href="http://www.manpagez.com/man/1/mdfind/"><code>mdfind</code></a> wasn't a solution ether. <a href="http://kitchingroup.cheme.cmu.edu/blog/2015/07/06/Indexing-headlines-in-org-files-with-swish-e-with-laser-sharp-results/">John Kitchin</a> gave a lot of
inspiration, but somehow it didn't quite fit. So I had to hack something by myself...
</p>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1">The indexer</h2>
<div class="outline-text-2" id="text-orgheadline1">
<p>
Because I think an all Lisp implementation is <i>sort-of</i> cool, I decided to write my indexer in Common Lisp
utilizing the Common Lisp <a href="https://lucene.apache.org/">Lucene</a> implementation majestically called <a href="http://www.cliki.net/Montezuma">Montezuma</a>.
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="font-weight: bold;">defpackage</span> :index-cli
  (<span style="font-weight: bold;">:use</span> <span style="font-weight: bold;">:cl</span> <span style="font-weight: bold;">:net.didierverna.clon</span>)
  (<span style="font-weight: bold;">:import-from</span> <span style="font-weight: bold;">:montezuma</span>
                <span style="font-weight: bold;">:add-field</span>
                <span style="font-weight: bold;">:make-field</span>)
  (<span style="font-weight: bold;">:export</span>
   #<span style="font-weight: bold;">:main</span>))

(<span style="font-weight: bold;">in-package</span> <span style="font-weight: bold;">:index-cli</span>)

(<span style="font-weight: bold;">defvar</span> *version* <span style="font-style: italic;">"0.1"</span>)
(<span style="font-weight: bold;">defvar</span> *index-path-name* <span style="font-style: italic;">".org-file-index"</span>)
(<span style="font-weight: bold;">defparameter</span> *index-path* (merge-pathnames *index-path-name*))

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">make-index</span> (&amp;key create-p)
  (make-instance 'montezuma:index
                 <span style="font-weight: bold;">:path</span> *index-path*
                 <span style="font-weight: bold;">:create-p</span> create-p
                 <span style="font-weight: bold;">:analyzer</span> (make-instance 'montezuma:standard-analyzer)
                 <span style="font-weight: bold;">:default-field</span> <span style="font-style: italic;">"*"</span>))

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">search-index</span> (query)
  (<span style="font-weight: bold;">let</span> ((index (make-index <span style="font-weight: bold;">:create-p</span> nil)))
    (<span style="font-weight: bold;">when</span> (= 0 (montezuma:search-each
                index
                query
                #'(<span style="font-weight: bold;">lambda</span> (doc-id score)
                    (<span style="font-weight: bold;">declare</span> (ignore score))
                    (format t <span style="font-style: italic;">"~A [~A|~A]~%"</span>
                            (montezuma:document-value
                             (montezuma:get-document index doc-id)
                             'title)
                            (montezuma:document-value
                             (montezuma:get-document index doc-id)
                             'file)
                            (montezuma:document-value
                             (montezuma:get-document index doc-id)
                             'buffer-position)))
                '(<span style="font-weight: bold;">:num-docs</span> 100000)))
      (format t <span style="font-style: italic;">"Not found~%"</span>))))

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">index-file</span> (filespec)
  (<span style="font-weight: bold;">let</span> ((all-docs (<span style="font-weight: bold;">with-open-file</span> (f filespec)
                    (read f)))
        (index (make-index <span style="font-weight: bold;">:create-p</span> t)))
    (<span style="font-weight: bold;">dolist</span> (doc all-docs)
    (montezuma:add-document-to-index index doc
       (make-instance 'montezuma:standard-analyzer)))
    (montezuma:optimize index)
    (montezuma:close index)))

<span style="color: #585858;">;;; </span><span style="color: #585858;">CLI</span>

(defsynopsis (<span style="font-weight: bold;">:postfix</span> <span style="font-style: italic;">"FILE"</span>)
  (text <span style="font-weight: bold;">:contents</span> <span style="font-style: italic;">"Index alist file"</span>)
  (path <span style="font-weight: bold;">:long-name</span> <span style="font-style: italic;">"index-path"</span> <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"i"</span> <span style="font-weight: bold;">:type</span> <span style="font-weight: bold;">:directory</span>
        <span style="font-weight: bold;">:description</span> <span style="font-style: italic;">"Index location. Defaults to current directory."</span>)
  (stropt <span style="font-weight: bold;">:long-name</span> <span style="font-style: italic;">"query"</span> <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"q"</span>
          <span style="font-weight: bold;">:description</span> <span style="font-style: italic;">"Search terms."</span>)
  (flag <span style="font-weight: bold;">:long-name</span> <span style="font-style: italic;">"help"</span> <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"h"</span>
        <span style="font-weight: bold;">:description</span> <span style="font-style: italic;">"Show this help text."</span>)
  (flag <span style="font-weight: bold;">:long-name</span> <span style="font-style: italic;">"version"</span> <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"v"</span>
        <span style="font-weight: bold;">:description</span> <span style="font-style: italic;">"Show the version."</span>))

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">main</span> (args)
  (setf sb-impl::*default-external-format* <span style="font-weight: bold;">:utf-8</span>)
  (make-context <span style="font-weight: bold;">:cmdline</span> args)
  (<span style="font-weight: bold;">when</span> (getopt <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"h"</span>)
    (help)
    (sb-ext:exit))
  (<span style="font-weight: bold;">when</span> (getopt <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"v"</span>)
    (format t <span style="font-style: italic;">"index-cli v~A~%"</span> *version*)
    (sb-ext:exit))
  (<span style="font-weight: bold;">let</span> ((index-path (getopt <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"i"</span>))
        (query (getopt <span style="font-weight: bold;">:short-name</span> <span style="font-style: italic;">"q"</span>)))
    (<span style="font-weight: bold;">when</span> index-path
      (setf *index-path* (merge-pathnames *index-path-name* index-path)))
    (<span style="font-weight: bold;">if</span> query
        (search-index query)
        (index-file (merge-pathnames (car (remainder)))))))
</pre>
</div>

<p>
The most important points are the <code>index-file</code> and the <code>search-index</code> functions. The file passed to
<code>index-file</code> should contain a list of alist. It iterates over this list and passes each alist to
Montezuma. Simple as that. The alists contains the following data:
</p>

<dl class="org-dl">
<dt><b>title</b></dt><dd>Usually the org headline.</dd>
<dt><b>contents</b></dt><dd>A paragraph's text. Meaning the text in between two org headlines.</dd>
<dt><b>file</b></dt><dd>The absolute file path to the file where <b>title</b> or <b>contents</b> has been extracted.</dd>
<dt><b>buffer-position</b></dt><dd>The position of the headline or paragraph in the buffer. Knowing that, it is easy to
jump directly to the occurrence of the search term. This will be important later.</dd>
</dl>

<p>
Example:
</p>

<div class="org-src-container">

<pre class="src src-lisp">((title . <span style="font-style: italic;">"An awesome title"</span>)
 (contents . <span style="font-style: italic;">"Much much content..."</span>)
 (file . <span style="font-style: italic;">"/Users/lispm/org/kb.org"</span>)
 (buffer-position . 311518))
</pre>
</div>

<p>
Each alist is a document in Lucene/Montezuma lingo. Note that <b>contents</b> is optional actually. This is because
I'm indexing headlines and paragraphs independently. But when I index a paragraph I put it's parent-headline
into the document as well. Admittedly this indexes the same headline multiple times which is
unnecessary actually, but I'm fine with that.
</p>

<p>
The <code>search-index</code> function applies the given query to the index an is explained quickly. If documents for
this query are found, each document gets printed to <b>standard-output</b>. For example, querying for <code>awesome title</code> writes
the above document like the following:
</p>

<pre class="example">
An awesome title [/Users/lispm/org/kb.org|311518]
</pre>

<p>
This output format still applies if the search term has been found inside the <b>contents</b> of a document. Thus
I've indexed the headline for paragraphs as well. To finalize the indexer, I've created an  executable with <a href="http://www.xach.com/lisp/buildapp/">buildapp</a>
and gave it a primitive CLI. The <b>-i</b> option
tells it where the index should be stored. The <b>-q</b> option searches the index. Omitting <b>-q</b> and passing the
documents file (the list of alists) indexes it.
</p>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2">The documents creator</h2>
<div class="outline-text-2" id="text-orgheadline2">
<p>
Next I needed a script that transforms my org file into a list of indexable documents.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #585858;">;;; </span><span style="color: #585858;">use the latest org</span>
(add-to-list 'load-path <span style="font-style: italic;">"/Users/fyi/.emacs.d/elpa/org-20150727/"</span>)
(<span style="font-weight: bold;">require</span> 'org)
(<span style="font-weight: bold;">require</span> 'xml)
(<span style="font-weight: bold;">require</span> 'json)

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">parent-headline</span> (element)
  (<span style="font-weight: bold;">let</span> ((parent (org-element-property <span style="font-weight: bold;">:parent</span> element)))
    (<span style="font-weight: bold;">cond</span>
      ((null parent)
       <span style="font-style: italic;">""</span>)
      ((and (eq 'headline (org-element-type parent))
            (eql 1 (org-element-property <span style="font-weight: bold;">:level</span> parent)))
       (org-element-property <span style="font-weight: bold;">:raw-value</span> parent))
      (t
       (parent-headline parent)))))

(find-file (expand-file-name (car command-line-args-left)))

(princ (append
        (org-map-entries
         (<span style="font-weight: bold;">lambda</span> ()
           (<span style="font-weight: bold;">let*</span> ((headline (org-element-at-point))
                  (title (org-element-property <span style="font-weight: bold;">:title</span> headline)))
             (<span style="font-weight: bold;">if</span> (equal title <span style="font-style: italic;">"Website Summary:"</span>)
                 <span style="font-style: italic;">""</span>
                 (format <span style="font-style: italic;">"((title . %S) (file . %S) (buffer-position . %s))"</span>
                         title
                         (buffer-file-name)
                         (prin1-to-string
                          (org-element-property <span style="font-weight: bold;">:begin</span> headline)))))))
        (org-element-map (org-element-parse-buffer) 'paragraph
          (<span style="font-weight: bold;">lambda</span> (paragraph)
            (format
             <span style="font-style: italic;">"((title . %S) (contents . %S) (file . %S) (buffer-position . %s))"</span>
             (parent-headline paragraph)
             (xml-escape-string
              (buffer-substring-no-properties
               (org-element-property <span style="font-weight: bold;">:contents-begin</span> paragraph)
               (org-element-property <span style="font-weight: bold;">:contents-end</span> paragraph)))
             (buffer-file-name)
             (prin1-to-string (org-element-property <span style="font-weight: bold;">:begin</span> paragraph)))))))
</pre>
</div>

<p>
The above script takes an org file and maps over each headline and paragraph an produces an alist
accordingly. Nothing special about it. I didn't know about the <code>org-element</code>-API before, which is quite nice.
</p>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-2">
<h2 id="orgheadline3">Swiper integration</h2>
<div class="outline-text-2" id="text-orgheadline3">
<p>
Lastly, everything get swiper-integrated to be usable from inside Emacs.
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">counsel-kb-search-function</span> (string &amp;rest unused)
  <span style="font-style: italic;">"Lookup STRING with index-cli"</span>
  (<span style="font-weight: bold;">if</span> (&lt; (length string) 3)
      (counsel-more-chars 3)
      (counsel--async-command
       (format <span style="font-style: italic;">"index-cli -i /Users/lispm/org -q \"%s\""</span> string))
      nil))

(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">search-kb</span> (&amp;optional initial-input)
  <span style="font-style: italic;">"Search KB"</span>
  (interactive)
  (ivy-read <span style="font-style: italic;">"search KB: "</span> 'counsel-kb-search-function
            <span style="font-weight: bold;">:initial-input</span> initial-input
            <span style="font-weight: bold;">:dynamic-collection</span> t
            <span style="font-weight: bold;">:history</span> 'counsel-git-grep-history
            <span style="font-weight: bold;">:action</span>
            (<span style="font-weight: bold;">lambda</span> (x)
              (<span style="font-weight: bold;">when</span> (string-match <span style="font-style: italic;">".*\\[</span><span style="font-style: italic;">\\</span><span style="font-style: italic;">(</span><span style="font-style: italic;">.*</span><span style="font-style: italic;">\\</span><span style="font-style: italic;">)</span><span style="font-style: italic;">|</span><span style="font-style: italic;">\\</span><span style="font-style: italic;">(</span><span style="font-style: italic;">[[:digit:]]+</span><span style="font-style: italic;">\\</span><span style="font-style: italic;">)</span><span style="font-style: italic;">\\]"</span> x)
                (<span style="font-weight: bold;">let</span> ((file-name (match-string 1 x))
                      (point (string-to-number (match-string 2 x))))
                  (find-file file-name)
                  (goto-char point)
                  (org-show-entry)
                  (show-children))))))
</pre>
</div>

<p>
The regexp matches the output of the indexer. Because I've indexed the file path and the buffer position I can jump
directly to the search term from swiper. Which is exactly what I wanted.  See a demo below:
</p>


<div class="figure">
<p><img src="/assets/blog/2015/08/19/on-indexing-org-files/index-cli-demo.gif" alt="index-cli demo" title="index-cli demo" width="700px" />
</p>
</div>
</div>
</div>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2015-08-19</span>
        <span title="last modification date" class="post-info">2015-08-19</span>
        <span title="tags" class="post-info"><a href="/tags/emacs/">emacs</a> <a href="/tags/search/">search</a> <a href="/tags/lisp/">lisp</a></span>
        <span title="author" class="post-info">Sebastian Christ</span>
      </div>
      <script src="http://code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.x (<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:rudolfo &lt;dot&gt; christ &lt;at&gt; gmail &lt;dot&gt; com">Sebastian Christ</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
